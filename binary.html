
<!DOCTYPE html>
<html>
<head>
	<title>Ensemble Weather</title>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
   <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
   <script type="text/javascript" src="slocum.js"></script>
	 <style type="text/css">
  	 #map { height: 800px;}
     .leaflet-popup-content {
       width: auto !important;
     }
     .leaflet-popup-tip {
      width: 0px;
      height: 0px;
     }
	 </style>
</head>
<body>

<div id="map"></div>

<div id="button-wrapper">
    <button onclick="changeValidTime()">next</button>
</div>

<div id="fcst-info">
Forecast for 0 hours from now
</div>

<dev id="spot"></div>


<script type="text/javascript">

var preloaded_data = []

var map = L.map('map', {
    minZoom: 2,
    maxZoom: 12
  }).setView([38, 235], 7);

var index = 0

L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      maxZoom: 18,
      id: 'mapbox/streets-v11',
      tileSize: 512,
      zoomOffset: -1,
      accessToken: 'pk.eyJ1IjoiYWtsZWVtYW4iLCJhIjoiY2txNGVkaHhwMGc2eDJwb3plNTh0aWJnZyJ9.l78GPBIaV7WwxqKtgEG76A'
  }).addTo(map);

var wind_circle_layer = L.layerGroup().addTo(map);

L.GridLayer.DebugCoords = L.GridLayer.extend({

   	initialize: function (options) {
   	  L.GridLayer.prototype.initialize.call(this, options);
  		this.m_tileLayers = {};
  	},

    tileId : function(coords) {
      return `${coords.x}_${coords.y}_${coords.z}`
    },

    createTile: function (coords, done) {
        var error;
        var tile = document.createElement('div');

        const id = this.tileId(coords);
        tile.id = id
        
        const layer = L.layerGroup().addTo(map);
        this.m_tileLayers[id] = layer;
    
        var hour = index * 6;
        path = `./data/${coords.z}/${hour}/${coords.x}_${coords.y}.bin`;
 
        LoadFile(path,  function (bytes) {
          circles = DrawAll(ParseSlocum(bytes), GetRadius(coords.z));
          L.layerGroup(circles).addTo(layer);
          done(error, tile);   
        });
        return tile;
    }
    
});

L.gridLayer.debugCoords = function(opts) {
    var output = new L.GridLayer.DebugCoords({tileSize: 512,
                                              maxNativeZoom: 8,
                                              minNativeZoom: 4});
    output.on('loading', function(e) {
      if (e.target == undefined) {
        return;
      }
      for (var key in e.target._tiles) {
        tile = e.target._tiles[key]
        if (!tile.current && tile.el.id in this.m_tileLayers) {
          map.removeLayer(this.m_tileLayers[tile.el.id]);
          delete this.m_tileLayers[tile.el.id];
        }
      }
    });
    return output;
};

map.addLayer( L.gridLayer.debugCoords() );

function ParseAndDraw(bytes) {
  var circles = DrawAll(ParseSlocum(bytes), GetRadius(map.getZoom()));
  L.layerGroup(circles).addTo(wind_circle_layer);
}

function changeValidTime() {

  index = index + 1
  if (index >= files.length) {
    index = 0
  }
  
  var hours = 6 * index
  document.getElementById("fcst-info").innerHTML = "Forecast for " + hours.toString() + " from now"
  
  //LoadFile(files[index], ParseAndDraw)
}

console.log("loading")
console.log("loaded")

</script>
</body>
</html> 
